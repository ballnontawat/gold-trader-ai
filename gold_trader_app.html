<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Gold Signal Bot (‡∏ö‡∏≠‡∏ó‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏≠‡∏á)</title>
    <!-- Load Tailwind CSS for responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase modules for database and authentication
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use Debug log level for Firestore in development
        setLogLevel('Debug');

        // Global variables for Firebase Config (MUST be provided by the environment)
        let firebaseConfig, appId, auth, db, userId = null;
        
        // --- Custom Tailwind Configuration (same as previous) ---
        window.onload = function() {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Tahoma', 'sans-serif'],
                        },
                        colors: {
                            'primary-gold': '#FFD700',
                            'dark-bg': '#1E293B',
                            'card-bg': '#334155',
                        }
                    }
                }
            };
            // Initialize Firebase and start the process
            initializeFirebaseAndAuth();
        };

        // ------------------------------------
        // FIREBASE INITIALIZATION & AUTH
        // ------------------------------------
        async function initializeFirebaseAndAuth() {
            try {
                // Initialize Firebase App
                if (typeof __firebase_config !== 'undefined') {
                    // This section runs only in the Canvas environment
                    firebaseConfig = JSON.parse(__firebase_config);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                } else {
                    // *** Fallback for GitHub Pages: Using YOUR provided config ***
                    console.warn("Using custom Firebase config for GitHub Pages.");
                    // Firebase Config Key for Project config-key-91147
                    firebaseConfig = { 
                        apiKey: "AIzaSyBtHWF0G-p_A6nmqp2vs-X8sYeJcgw31C4", // <--- Firebase Config Key
                        authDomain: "config-key-91147.firebaseapp.com",
                        projectId: "config-key-91147",
                        storageBucket: "config-key-91147.firebasestorage.app",
                        messagingSenderId: "829185427257",
                        appId: "1:829185427257:web:884171fb68fd8c2082cae8",
                        measurementId: "G-P70JTKGV13"
                    }; 
                    appId = firebaseConfig.projectId; // Use Project ID as App ID
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously or with custom token (Essential for Firestore write rule)
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state change
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Start listening to data once authenticated
                        setupSignalHistoryListener();
                        // Generate a signal on load (optional: comment out if you don't want a signal on every load)
                        // generateSignal(); 
                    } else {
                        // Not authenticated, use anonymous/random ID for public-like access simulation
                        userId = crypto.randomUUID();
                        setupSignalHistoryListener();
                        // generateSignal();
                    }
                    document.getElementById('userIdDisplay').textContent = userId || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
                });

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                displayError(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
            }
        }

        // ------------------------------------
        // FIRESTORE FUNCTIONS
        // ------------------------------------

        // Helper to get the correct collection path (Public for collaborative stats)
        function getSignalCollectionRef() {
            // Using a public path so all users can see the aggregate statistics (Win Rate)
            const collectionPath = `artifacts/${appId}/public/data/gold_signals`;
            return collection(db, collectionPath);
        }

        // Save the generated signal to Firestore
        async function saveSignalToDB(signalData) {
            if (!db || !userId) {
                console.error("Cannot save signal: DB or User ID not ready.");
                return; 
            }

            // Use a unique ID based on timestamp and user to avoid conflicts
            const docId = `${Date.now()}-${userId.substring(0, 8)}`; 
            
            try {
                await setDoc(doc(getSignalCollectionRef(), docId), {
                    ...signalData,
                    userId: userId, // Record which user generated it
                    timestamp: serverTimestamp(),
                    isClosed: false, 
                    result: 'PENDING' 
                });
                console.log("Signal saved successfully with ID:", docId);
            } catch (error) {
                console.error("Error saving signal to Firestore:", error);
                // We show an error, but the signal generation might still be okay
                displayError(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Security Rules (‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)`);
            }
        }

        // Setup real-time listener for signal history and stats
        function setupSignalHistoryListener() {
            if (!db) return;

            // Query: Get the last 100 signals
            const signalsQuery = query(
                getSignalCollectionRef(),
                orderBy('timestamp', 'desc'),
                limit(100)
            );

            onSnapshot(signalsQuery, (snapshot) => {
                let totalSignals = 0;
                let mockWins = 0; 
                
                snapshot.forEach(doc => {
                    totalSignals++;
                    // Mocking Win/Loss for front-end display realism
                });

                // Simple mock logic: Assumes a base 55% Win Rate with slight random variance
                let winRate = 0;
                if (totalSignals > 0) {
                    // Generate a number of mock wins close to 55%
                    mockWins = Math.round(totalSignals * 0.55 + Math.floor(Math.random() * 5));
                    if (mockWins > totalSignals) mockWins = totalSignals - 1; 
                    winRate = (mockWins / totalSignals) * 100;
                }
                
                updateStatsUI(totalSignals, winRate);
            }, (error) => {
                console.error("Error listening to signals:", error);
                // Do not display this as a fatal error, as signal generation still works
            });
        }

        // Update the statistics section
        function updateStatsUI(totalSignals, winRate) {
            document.getElementById('totalSignals').textContent = totalSignals.toLocaleString();
            document.getElementById('winRate').textContent = `${winRate.toFixed(0)}%`;
            // userIdDisplay is updated in onAuthStateChanged
        }

        // ------------------------------------
        // UI & API LOGIC (Unchanged, using the fixed API Key)
        // ------------------------------------
        
        // Gemini API configuration
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Gemini API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ***
        const apiKey = "AIzaSyD1a62baK2DTiOjtRrRasFuPgGEvOSNPS8"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // UI Element References (unchanged)
        const signalCard = document.getElementById('signalCard');
        const generateSignalBtn = document.getElementById('generateSignalBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const generateSummaryBtn = document.getElementById('generateSummaryBtn');
        const summaryButtonText = document.getElementById('summaryButtonText');
        const summaryLoadingIndicator = document.getElementById('summaryLoadingIndicator');
        const marketSummaryCard = document.getElementById('marketSummaryCard');
        const marketSummaryContent = document.getElementById('marketSummaryContent');

        const signalDirection = document.getElementById('signalDirection');
        const signalEntry = document.getElementById('signalEntry');
        const signalTP = document.getElementById('signalTP');
        const signalSL = document.getElementById('signalSL');
        const signalReason = document.getElementById('signalReason');
        const timeframeSelect = document.getElementById('timeframeSelect');

        const sourceContainer = document.getElementById('sourceContainer');
        const sourceList = document.getElementById('sourceList');
        const errorMessage = document.getElementById('errorMessage');

        // Function to display error message
        function displayError(message, isSummary = false) {
            errorMessage.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${message}`;
            errorMessage.classList.remove('hidden');
            if (isSummary) {
                marketSummaryCard.classList.add('hidden');
            } else {
                signalCard.classList.add('hidden');
            }
        }

        // Function to handle API call and retries with exponential backoff
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429 || response.status >= 500) {
                        // Retry for rate limiting (429) or server errors (5xx)
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Request failed with status ${response.status}. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        // Non-retryable error
                        const errorData = await response.json();
                        throw new Error(`API Error ${response.status}: ${errorData.error.message}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    // Continue loop for retry
                }
            }
        }

        // ------------------------------------
        // CORE FEATURE 1: Generate Trading Signal
        // ------------------------------------
        window.generateSignal = async function() {
            // Check if Gemini API Key is set
            if (apiKey === "YOUR_GEMINI_API_KEY_HERE" || !apiKey) {
                displayError("‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Gemini API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 166)");
                return;
            }

            // Reset UI
            errorMessage.classList.add('hidden');
            signalCard.classList.add('hidden');
            sourceList.innerHTML = '';
            sourceContainer.classList.add('hidden');
            signalDirection.className = 'text-2xl font-black mt-1 p-1 rounded'; // Reset classes for new color

            // Get selected timeframe
            const selectedTimeframe = timeframeSelect.value;
            document.getElementById('signalTimeframe').textContent = `‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: ${selectedTimeframe}`;

            // Set loading state
            generateSignalBtn.disabled = true;
            buttonText.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            // --- SYSTEM PROMPT for Signal ---
            const systemPrompt = `
                Act as a highly reliable gold trading signal provider for XAUUSD.
                You must analyze current global economic news, USD performance, and technical sentiment to provide a concise, actionable signal based on the ${selectedTimeframe} timeframe.
                Your response must be in Thai and must strictly adhere to the following 6-line, easily parsable format:

                SIGNAL: [‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢/‡∏£‡∏≠ (BUY/SELL/WAIT)]
                TIMEFRAME: [‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô H4/Daily]
                ENTRY: [‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ USD ‡πÄ‡∏ä‡πà‡∏ô 2350.50]
                TP: [‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ USD ‡πÄ‡∏ä‡πà‡∏ô 2380.00]
                SL: [‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ USD ‡πÄ‡∏ä‡πà‡∏ô 2335.50]
                REASON: [1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå]
            `;
            
            const userQuery = `‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ (XAUUSD) ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ${selectedTimeframe} ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤, TP, SL, ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    temperature: 0.1
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
                }

                const rawText = candidate.content.parts[0].text.trim();
                
                // 1. Parse the structured text output
                const lines = rawText.split('\n').map(line => line.trim());
                let signal = {
                    DIRECTION: 'WAIT',
                    TIMEFRAME: selectedTimeframe,
                    ENTRY: '-',
                    TP: '-',
                    SL: '-',
                    REASON: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô'
                };

                lines.forEach(line => {
                    if (line.startsWith('SIGNAL:')) {
                        signal.DIRECTION = line.split(':')[1]?.trim() || 'WAIT';
                    } else if (line.startsWith('TIMEFRAME:')) {
                        const tf = line.split(':')[1]?.trim();
                        if (tf) {
                            signal.TIMEFRAME = tf.toUpperCase();
                        }
                    } else if (line.startsWith('ENTRY:')) {
                        signal.ENTRY = line.split(':')[1]?.trim() || '-';
                    } else if (line.startsWith('TP:')) {
                        signal.TP = line.split(':')[1]?.trim() || '-';
                    } else if (line.startsWith('SL:')) {
                        signal.SL = line.split(':')[1]?.trim() || '-';
                    } else if (line.startsWith('REASON:')) {
                        signal.REASON = line.substring(line.indexOf(':') + 1).trim() || signal.REASON;
                    }
                });

                // 2. Update UI
                signalCard.classList.remove('hidden');

                // Update Direction and apply color styling
                signalDirection.textContent = signal.DIRECTION;
                if (signal.DIRECTION.includes('‡∏ã‡∏∑‡πâ‡∏≠') || signal.DIRECTION.toUpperCase().includes('BUY')) {
                    signalDirection.classList.add('buy-signal', 'text-white');
                } else if (signal.DIRECTION.includes('‡∏Ç‡∏≤‡∏¢') || signal.DIRECTION.toUpperCase().includes('SELL')) {
                    signalDirection.classList.add('sell-signal', 'text-white');
                } else {
                    signalDirection.classList.add('wait-signal', 'text-dark-bg');
                }
                
                document.getElementById('signalTimeframe').textContent = `‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: ${signal.TIMEFRAME}`;

                // Display prices, ensure they are clean
                signalEntry.textContent = signal.ENTRY.replace('USD', '').trim();
                signalTP.textContent = signal.TP.replace('USD', '').trim();
                signalSL.textContent = signal.SL.replace('USD', '').trim();
                signalReason.textContent = signal.REASON;

                // 3. Extract and display grounding sources
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                if (sources.length > 0) {
                    sourceContainer.classList.remove('hidden');
                    sourceList.innerHTML = ''; 
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="${source.uri}" target="_blank" class="hover:text-primary-gold transition duration-200 truncate block">${source.title}</a>`;
                        sourceList.appendChild(li);
                    });
                } else {
                    sourceContainer.classList.add('hidden');
                }

                // 4. Save the signal to Firestore for backtesting (Requires all fields)
                saveSignalToDB({
                    direction: signal.DIRECTION,
                    timeframe: signal.TIMEFRAME,
                    entry: signal.ENTRY.replace('USD', '').trim(),
                    tp: signal.TP.replace('USD', '').trim(),
                    sl: signal.SL.replace('USD', '').trim(),
                    reason: signal.REASON
                });

            } catch (error) {
                console.error("Gemini API Call Failed (Signal):", error);
                displayError(error.message || "‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì");
            } finally {
                // Remove loading state
                generateSignalBtn.disabled = false;
                buttonText.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            }
        }

        // ------------------------------------
        // CORE FEATURE 2: Market Summary & Strategy (Unchanged)
        // ------------------------------------
        window.generateSummary = async function() {
            // Check if Gemini API Key is set
            if (apiKey === "YOUR_GEMINI_API_KEY_HERE" || !apiKey) {
                displayError("‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Gemini API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 166)");
                return;
            }

            // Reset UI
            marketSummaryCard.classList.add('hidden');
            errorMessage.classList.add('hidden');
            marketSummaryContent.innerHTML = '';

            // Set loading state
            generateSummaryBtn.disabled = true;
            summaryButtonText.classList.add('hidden');
            summaryLoadingIndicator.classList.remove('hidden');

            // --- SYSTEM PROMPT for Summary ---
            const systemPrompt = `
                Act as a chief market strategist specializing in precious metals. Provide a comprehensive, easy-to-read daily market overview for XAUUSD (Gold). The analysis must include:
                1. Current Market Sentiment (Bullish/Bearish/Neutral).
                2. Key Driving Factors (Economic data, USD strength, or geopolitical risks).
                3. A general Strategic Approach (e.g., Range trading, Trend following, or Caution).

                The response must be in Thai and should not be a trading signal (no ENTRY, TP, SL). Structure the response clearly with markdown formatting (e.g., **heading** and bullet lists).
            `;
            
            const userQuery = "‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ï‡∏•‡∏≤‡∏î‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ XAUUSD ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    temperature: 0.2
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏•‡∏≤‡∏î‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
                }

                const summaryText = candidate.content.parts[0].text.trim();
                
                // Convert the markdown output to simple HTML structure for display
                const htmlContent = summaryText
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-primary-gold">$1</strong>') // Bold text
                    .replace(/\n\n/g, '</p><p>') // Double newlines to paragraphs
                    .replace(/\n/g, '<br>') // Single newlines to breaks
                    .replace(/<p><br>/g, '<p>'); // Clean up stray <br> after <p>

                marketSummaryContent.innerHTML = `<p>${htmlContent}</p>`;
                marketSummaryCard.classList.remove('hidden');

            } catch (error) {
                console.error("Summary API Call Failed:", error);
                displayError(error.message || "‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏•‡∏≤‡∏î", true);
            } finally {
                // Remove loading state
                generateSummaryBtn.disabled = false;
                summaryButtonText.classList.remove('hidden');
                summaryLoadingIndicator.classList.add('hidden');
            }
        }
    </script>

    <style>
        body {
            background-color: #0F172A; /* Slate 900 */
            color: #E2E8F0; /* Slate 200 */
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .signal-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .buy-signal {
            background-color: #10B981; /* Green 500 */
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .sell-signal {
            background-color: #EF4444; /* Red 500 */
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .wait-signal {
            background-color: #FACC15; /* Yellow 400 */
            color: #1E293B;
            padding: 4px 8px;
            border-radius: 6px;
        }
        /* Custom Loading Indicator */
        .loading-animation {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #FFD700; /* Gold */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- UI: Add the Performance Tracker Section -->
    <div class="w-full max-w-lg">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-primary-gold mb-2">
                <span class="text-5xl">G</span>old <span class="text-5xl">T</span>rader <span class="text-5xl">A</span>I
            </h1>
            <p class="text-lg text-slate-300">‡∏ö‡∏≠‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ (XAUUSD)</p>
            <p class="text-sm text-slate-500 mt-1">‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢ Gemini ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡∏à‡∏≤‡∏Å Google Search</p>
        </header>

        <!-- New: Performance Tracker -->
        <div class="signal-card bg-card-bg rounded-xl p-6 mb-6">
            <h2 class="text-xl font-bold border-b pb-3 mb-4 text-primary-gold flex justify-between items-center">
                üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Backtest Mock)
            </h2>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <p class="text-slate-400 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</p>
                    <p id="totalSignals" class="text-3xl font-bold mt-1 text-primary-gold">0</p>
                </div>
                <div>
                    <p class="text-slate-400 text-sm">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (Win Rate)</p>
                    <p id="winRate" class="text-3xl font-bold mt-1 text-green-500">0%</p>
                </div>
            </div>
            <p class="text-xs text-slate-500 mt-4 italic text-center">
                *‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á (Mock) ‡∏ó‡∏µ‡πà‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏Ø ‡∏ô‡∏µ‡πâ. (User ID: <span id="userIdDisplay" class="font-mono text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>)
            </p>
        </div>


        <main class="space-y-6">
            <!-- Timeframe Selection (rest of UI is the same) -->
            <div class="flex items-center justify-center space-x-3 mb-4">
                <label for="timeframeSelect" class="text-slate-300 font-medium text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Timeframe:</label>
                <select id="timeframeSelect" class="bg-card-bg text-primary-gold border border-slate-600 rounded-lg p-2 focus:ring-primary-gold focus:border-primary-gold">
                    <option value="M5">M5 (5 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                    <option value="M15">M15 (15 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                    <option value="M30">M30 (30 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                    <option value="H1">H1 (1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</option>
                    <option value="H4" selected>H4 (4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</option>
                    <option value="D1">D1 (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</option>
                </select>
            </div>

            <!-- Signal Generation Button -->
            <div class="text-center">
                <button id="generateSignalBtn" onclick="generateSignal()"
                    class="w-full sm:w-auto px-8 py-3 bg-primary-gold text-dark-bg font-extrabold rounded-xl transition duration-300 transform hover:scale-105 active:scale-95 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="buttonText">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡πÉ‡∏´‡∏°‡πà
                    </span>
                    <div id="loadingIndicator" class="loading-animation hidden"></div>
                </button>
            </div>

            <!-- Market Summary Button -->
            <div class="text-center mt-4">
                <button id="generateSummaryBtn" onclick="generateSummary()"
                    class="w-full sm:w-auto px-8 py-3 bg-slate-700 text-primary-gold font-extrabold rounded-xl transition duration-300 transform hover:bg-slate-600 active:scale-95 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="summaryButtonText">
                        ‚ú® ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏•‡∏≤‡∏î & ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                    </span>
                    <div id="summaryLoadingIndicator" class="loading-animation hidden"></div>
                </button>
            </div>


            <!-- Signal Display Card -->
            <div id="signalCard" class="signal-card bg-card-bg rounded-xl p-6 hidden">
                <h2 class="text-2xl font-bold border-b pb-3 mb-4 flex justify-between items-center text-primary-gold">
                    <span>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                    <!-- Timeframe Display -->
                    <span id="signalTimeframe" class="text-base font-semibold px-3 py-1 bg-slate-700 rounded-full text-slate-300">‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: -</span>
                </h2>

                <!-- Layout adapted for mobile first: two columns on larger screens -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Signal Type -->
                    <div class="p-3 rounded-lg border border-slate-600">
                        <p class="text-slate-400 text-sm">‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (SIGNAL)</p>
                        <p id="signalDirection" class="text-2xl font-black mt-1"></p>
                    </div>

                    <!-- Entry Price -->
                    <div class="p-3 rounded-lg border border-slate-600">
                        <p class="text-slate-400 text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (ENTRY)</p>
                        <p id="signalEntry" class="text-xl font-semibold mt-1 text-slate-200"></p>
                    </div>

                    <!-- Target Price -->
                    <div class="p-3 rounded-lg border border-slate-600">
                        <p class="text-slate-400 text-sm">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≥‡πÑ‡∏£ (TP)</p>
                        <p id="signalTP" class="text-xl font-semibold mt-1 text-green-400"></p>
                    </div>

                    <!-- Stop Loss -->
                    <div class="p-3 rounded-lg border border-slate-600">
                        <p class="text-slate-400 text-sm">‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (SL)</p>
                        <p id="signalSL" class="text-xl font-semibold mt-1 text-red-400"></p>
                    </div>
                </div>

                <!-- Analysis/Reason -->
                <div class="bg-slate-700 p-4 rounded-lg">
                    <p class="text-sm font-semibold text-primary-gold mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (REASON)</p>
                    <p id="signalReason" class="text-base text-slate-300 italic"></p>
                </div>

                <!-- Sources/Grounding -->
                <div id="sourceContainer" class="mt-4 border-t pt-4 border-slate-700 hidden">
                    <p class="text-xs font-semibold text-slate-400 mb-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</p>
                    <ul id="sourceList" class="text-xs text-slate-500 space-y-1">
                        <!-- Sources will be injected here -->
                    </ul>
                </div>
            </div>

            <!-- Market Summary Display Card -->
            <div id="marketSummaryCard" class="signal-card bg-card-bg rounded-xl p-6 hidden">
                <h2 class="text-2xl font-bold border-b pb-3 mb-4 text-primary-gold">
                    ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ï‡∏•‡∏≤‡∏î‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Gemini Analysis)
                </h2>
                <div id="marketSummaryContent" class="text-base text-slate-300 space-y-3">
                    <!-- Summary content will be injected here -->
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden p-4 bg-red-800/30 text-red-400 rounded-xl border border-red-700 text-center">
                <!-- Error message will be displayed here -->
            </div>
        </main>
    </div>
</body>
</html>
